#
#* Copyright (C) 2025-2025 sbwml
#* https://github.com/sbwml/luci-app-mosdns/blob/v5/.github/workflows/release-build.yml
#* This is free software, licensed under the GNU General Public License v3.
#* See /LICENSE for more information.
#
#

name: Build luci-app-pushbot

on:
  push:
    tags:
      - "v*"

env:
  TZ: Asia/Shanghai

jobs:
  build:
    name: Build ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x86_64
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_arm1176jzf-s_vfp
          - arm_arm926ej-s
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_fa526
          - arm_xscale
          - i386_pentium-mmx
          - i386_pentium4
          - loongarch64_generic
          - mips64_mips64r2
          - mips64_octeonplus
          - mips64el_mips64r2
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - riscv64_riscv64
        sdk:
          - openwrt-24.10
          - SNAPSHOT
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Prepare Feed Directory
        run: |
          mkdir -p openwrt-feed/luci-app-pushbot
          mkdir -p openwrt-feed/aes-tool
          
          # å¤åˆ¶ luci-app-pushbot
          cp -r luci-app-pushbot/* openwrt-feed/luci-app-pushbot/
          
          # å¤åˆ¶ aes-tool
          cp -r aes-tool/* openwrt-feed/aes-tool/
      - name: Build Packages
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEED_DIR: ${{ github.workspace }}/openwrt-feed
          FEEDNAME: packages_ci
          PACKAGES: aes-tool luci-app-pushbot  # ç¼–è¯‘ä¸¤ä¸ªåŒ…
          NO_REFRESH_CHECK: true
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/riscv64_generic/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
      - name: Create compress files
        continue-on-error: true
        run: |
          if [ "${{ matrix.arch }}" = "riscv64_riscv64" ] && [ "${{ matrix.sdk }}" = "SNAPSHOT" ]; then
            find "bin/packages/riscv64_generic/packages_ci" -type d -empty -delete
            tar -zcvf ${{ matrix.sdk }}-${{ matrix.arch }}.tar.gz -C bin/packages/riscv64_generic/ packages_ci
          else
            find "bin/packages/${{ matrix.arch }}/packages_ci" -type d -empty -delete
            tar -zcvf ${{ matrix.sdk }}-${{ matrix.arch }}.tar.gz -C bin/packages/${{ matrix.arch }}/ packages_ci
          fi
      - name: Upload packages
        uses: ncipollo/release-action@v1
        with:
          name: ${{ github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: true
          prerelease: false
          artifacts: "${{ matrix.sdk }}-${{ matrix.arch }}.tar.gz"
          body: |
            ## ğŸ‰ LuCI App Pushbot ${{ github.ref_name }}

            âœ… **å…¨æ¶æ„ç¼–è¯‘å®Œæˆï¼**

            ### ğŸ“¦ å¿«é€Ÿå®‰è£…

            1. åœ¨ä¸‹æ–¹ **Assets** ä¸­æ‰¾åˆ°ä½ çš„è®¾å¤‡æ¶æ„
            2. ä¸‹è½½å¯¹åº”çš„ `.ipk` æˆ– `.apk` æ–‡ä»¶
            3. ä¸Šä¼ åˆ°è·¯ç”±å™¨å¹¶å®‰è£…

            ```bash
            # IPK å®‰è£…ï¼ˆæ—§ç‰ˆ OpenWrtï¼‰
            opkg install luci-app-pushbot-*.ipk  aes-tool-*.ipk

            # APK å®‰è£…ï¼ˆOpenWrt 24.10+ï¼‰
            apk add --allow-untrusted luci-app-pushbot-*.apk aes-tool-*.apk
            ```

            ### ğŸ—ï¸ æ”¯æŒçš„æ¶æ„ (å…±64ä¸ªåŒ…)

            #### ğŸ–¥ï¸ x86 æ¶æ„
            - `x86_64` - 64ä½ x86 è®¾å¤‡
            - `i386_pentium4`, `i386_pentium-mmx` - 32ä½ x86 è®¾å¤‡

            #### ğŸ“± ARM 64ä½ (aarch64)
            - `aarch64_generic` - é€šç”¨ ARM64
            - `aarch64_cortex-a53` - Cortex-A53 (æ ‘è“æ´¾3)
            - `aarch64_cortex-a72` - Cortex-A72 (æ ‘è“æ´¾4)
            - `aarch64_cortex-a76` - Cortex-A76

            #### ğŸ“± ARM 32ä½
            - `arm_cortex-a7` - Cortex-A7
            - `arm_cortex-a9` - Cortex-A9
            - `arm_cortex-a15_neon-vfpv4` - Cortex-A15
            - ç­‰å¤šä¸ª ARM å­æ¶æ„

            #### ğŸŒ MIPS æ¶æ„  
            - `mipsel_24kc` - MT7621è·¯ç”±å™¨ (å°ç±³ã€çº¢ç±³ç­‰)
            - `mips_24kc` - AR71xxè·¯ç”±å™¨
            - `mips64_octeonplus` - Cavium Octeon
            - ç­‰å¤šä¸ª MIPS å˜ç§

            #### ğŸ†• å…¶ä»–æ¶æ„
            - `riscv64_riscv64` - RISC-V 64ä½
            - `loongarch64_generic` - é¾™èŠ¯æ¶æ„

            ### ğŸ“‹ SDK ç‰ˆæœ¬è¯´æ˜

            | ç‰ˆæœ¬ | è¯´æ˜ | æ¨è |
            |------|------|------|
            | **openwrt-24.10** | ç¨³å®šç‰ˆï¼Œç»è¿‡å……åˆ†æµ‹è¯• | â­ æ¨è |
            | **SNAPSHOT** | å¼€å‘ç‰ˆï¼ŒåŒ…å«æœ€æ–°åŠŸèƒ½ | å°é²œ |

            ### ğŸ’¡ ä¸çŸ¥é“é€‰å“ªä¸ªï¼Ÿ

            **æ–¹æ³•1**: SSH åˆ°è·¯ç”±å™¨æ‰§è¡Œ
            ```bash
            opkg print-architecture

            apk --print-arch
            ```

            **æ–¹æ³•2**: æŸ¥çœ‹è·¯ç”±å™¨å‹å·
            - å°ç±³/çº¢ç±³è·¯ç”±å™¨ â†’ `mipsel_24kc`
            - æ ‘è“æ´¾4 â†’ `aarch64_cortex-a72`
            - x86è½¯è·¯ç”± â†’ `x86_64`

            **æ–¹æ³•3**: æŸ¥çœ‹ OpenWrt ç‰ˆæœ¬
            ```bash
            cat /etc/openwrt_release
            ```

            ---

            **Star â­ æœ¬é¡¹ç›®å¯ä»¥è·å–æ›´æ–°é€šçŸ¥ï¼**